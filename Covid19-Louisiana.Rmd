---
title: "COVID-19 in Louisiana - A Time Series Analysis"
author: "Dustin Bracy"
date: "11/19/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

library(tswge)
library(tidyverse)
library(ggthemes)
library(RColorBrewer)
library(gridExtra)
library(vars)
library(nnfor)

# Get US Data & reverse order
us <- read_csv('./data/national-history.csv')
us <- us[order(us$date),]

# Get LA Data & consolidate to state level
ladata <- readxl::read_xlsx('./data/LA_COVID_TESTBYDAY_PARISH_PUBLICUSE.xlsx')
la <- ladata %>%
  group_by(date = `Lab Collection Date`) %>%
  summarise(
    tests = sum(`Daily Test Count`),
    positive = sum(`Daily Positive Test Count`),
    negative = sum(`Daily Negative Test Count`),
    cases = sum(`Daily Case Count`)
)

# Create Positivity features
la$positivity = la$positive / la$tests
us$positivity <- us$positiveIncrease / us$totalTestResultsIncrease

# Get temp data from WeatherUnderground.com (historical data for MSY)
## Note Nov8 data missing from site, so imputed average of Nov7+9 was taken
xdf <- read_csv('./data/temp.csv')
xdf$GatheringBinary <- as.numeric(ifelse(is.na(xdf$Gathering), 0,1))

# Start on March 11, end on Nov 11
la <- la[11:256,]
us <- tail(us, 256)
us <- head(us, 246)
xdf <- xdf[11:256,]


eval_model <- function(response, predictions, pred_ul = NA, pred_ll = NA, model_name, AIC_val = 0, ending_point = length(response)) {
  num_predictions = length(predictions)
  test_stop <- length(response)
  test_start <- test_stop - num_predictions + 1
  compare_stop <- test_start - 1
  compare_start <- compare_stop - num_predictions + 1
  ASE <- mean((predictions - response[test_start:test_stop])^2)

  # Build predictions dataframe
  df <- data.frame('Predicted' = predictions)
  df$Day = row(df)
  df$Actual = response[test_start:test_stop]
  df <- gather(df, key='Type', value, -Day)
  
  #if we have enough data to plot num_predictions * 2, do it, else use num_predictions
  starting_point <- compare_start - num_predictions + 1
  plot_start <- ifelse(starting_point < 0, compare_start, starting_point)
  day_multiplier <- ifelse(starting_point < 0, -1,-2)
  
  # Build predicted vs actual dataframe
  df <- rbind(df, 
    data.frame("Day"=c(((num_predictions-1)*day_multiplier):0), 
               "Type" = 'Actual', 
               value = response[plot_start:compare_stop]))

  # Built UL/LL dataframes
  ul <- data.frame("Day"=c(1:num_predictions), pred_ul)
  ll <- data.frame("Day"=c(1:num_predictions), pred_ll)
  
  # Build Plot
  comparison_plot <- ggplot() + 
    geom_line(data=df, aes(Day + ending_point - num_predictions, value, color=Type)) + 
    geom_point(size=.75) + 
    labs(title=paste(model_name, 'Performance Evaluation'),
         subtitle=paste0(num_predictions,'-Day Forecast'), 
         x='Day', 
         y='Positivity Rate',
         caption=paste0('ASE: ',round(ASE,6),
                       '\nAIC: ',round(AIC_val,6)))
  
  # Add confidence intervals if supplied
  if (length(pred_ul) == length(predictions)){
    comparison_plot = comparison_plot + 
      geom_line(aes(ul$Day + ending_point - num_predictions, ul$pred_ul), 
                color='grey70', linetype = "dashed") 
  }
  if (length(pred_ll) == length(predictions)){
    comparison_plot = comparison_plot + 
      geom_line(aes(ll$Day + ending_point - num_predictions, ll$pred_ll), 
                color='grey70', linetype = "dashed") 
    }
  
  return(comparison_plot)
}



#example:
e <- est.arma.wge(us.d1, p=12, q=2)
preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 7, lastn = T, limits = F)
eval_model(us$positivity, preds$f, preds$ul, preds$ll, model_name = 'ARIMA(12,1,2)', AIC_val = e$aic) #ASE = .000156

preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 90, lastn = T, limits = F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll, 'ARIMA(12,1,2)', e$aic) 


```

# Introduction
My name is Dustin Bracy, and this is a time series analysis of COVID-19 data in Louisiana and the United States spanning an 8 month period from the declaration of the pandemic on March 11, 2020 through November 11, 2020.

## Metrics used for reporting
*Positivity rate* - According to John Hopkins University, the positivity rate is a new measure developed to identify either trending increases in transmission rates, or overall drops in testing rates, which can indicate a shortage of tests.  It measures the ratio of diagnostic tests which are actually positive (i.e. # of positive tests / # of total tests). 

The idea behind this test is that a high positivity score should give leaders indication that either infection is increasing at an unusual rate, or not enough tests are available.  The World Health Organization has recommended nations adopt a rule of thumb to keep populations under approximately 5% positivity rate before considering re-opening or relaxing social restrictions.

The positivity rate improves upon strictly measuring the total number of cases or positive results by better accounting for new tests. As time goes on, more individuals will be re-tested, including high risk individuals such as health care workers, who may receive tests and positive results more frequently than others.  The positivity rate accounts for this by measuring the total number of positive cases against tests, which will show less bias than strictly reporting on positive cases, which can be inflated by duplicate tests and non-unique cases.  A better way to control this bias is to measure the people testing positive over the people who have been tested, although this data is much more difficult to collect, due to HIPAA and privacy concerns with linking data to individuals.

## Sources used
https://www.jhsph.edu/covid-19/articles/covid-19-testing-understanding-the-percent-positive.html
https://www.mprnews.org/story/2020/08/12/behind-the-numbers-what-does-a-covid19-positivity-rate-really-mean


```{r PositivityComparison}

#census.gov reported populations on Jul 1, 2019: Louisiana / USA
lapopratio <- 4648794 / 328239523

positivity_df <- data.frame(cbind(la[c('date', 'positivity')],  us['positivity']))
names(positivity_df) = c('date','LA','US')

positive_df <- data.frame(cbind(la[c('date', 'positive')],  us['positiveIncrease']))
names(positive_df) = c('date','LA','US')
positive_df$US = positive_df$US * lapopratio


grid.arrange(
  gather(positivity_df, key = Region, value = 'Positivity Rate', -date) %>% 
    ggplot(aes(date, `Positivity Rate`)) + 
    geom_line(aes(color=Region), size=1) + 
    labs(title='Louisiana vs US Positivity Rate', 
         x = 'Date', 
         y='Positivity Rate') +
    theme_fivethirtyeight(), 

  gather(positive_df, key = Region, value = 'Positive Tests', -date) %>% 
    ggplot(aes(date, `Positive Tests`)) + 
    geom_line(aes(color=Region), size=1) + 
    labs(title='Louisiana vs US Daily New Positive Tests', 
         x = 'Date', 
         y='Positive Tests', 
         subtitle = '*US numbers scaled to 1.42%') + 
    theme_fivethirtyeight(),
  ncol = 2)

```


```{r Louisiana}
## TODO Jung Box Test
## TODO Compare ACF/Spectral Densities

plotts.sample.wge(la$positivity)

plotts.wge(la$positivity)

parzen.wge(la$positivity, trun=100)

aic5.wge(la$positivity, p = 0:12, q=0:5, type='bic')

# Take out 1-B
la.d1 <- artrans.wge(la$positivity,1)

# Taking out another 1-B.. looks like it isn't enough
artrans.wge(la.d1,1)

# strong evidence of a 7 day cycle + possibly a monthly cycle
la.s7 <- artrans.wge(la$positivity, c(rep(0,6),1))

# Take out a 1-B + the (1-B)^7.. looks like white noise
la.d1.s7 <- artrans.wge(la.d1, c(rep(0,6),1))
la.d1.s7.s12 <- artrans.wge(la.d1, c(rep(0,6),1,0,0,0,0,1))


# 1-B + s7
aic5.wge(la.d1.s7, p=0:15, q=0:5, type='bic') #BIC recommends 12/2>12/1>8/1>7/1>9/1

aic5.wge(la.d1.s7.s12, p=0:15)


e <- est.arma.wge(la.d1.s7,p = 12, q=2)
ljung.wge(e$res, p=12,q=2, K=24)
ljung.wge(e$res, p=12,q=2, K=48)
preds <- fore.aruma.wge(la$positivity, phi = e$phi, theta=e$theta, d=1, s=7, n.ahead = 7, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,'ARIMA(12,1,2) With Weekly Trend', e$aic) #ASE = .000465

preds <- fore.aruma.wge(la$positivity, phi = e$phi, theta=e$theta, d=1, s=7, n.ahead = 90, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,'ARIMA(12,1,2) With Weekly Trend', e$aic) #ASE = .016857

e <- est.arma.wge(la.d1.s7.s12,p = 12, q=2)
ljung.wge(e$res, p=12,q=2, K=24)
ljung.wge(e$res, p=12,q=2, K=48)
preds <- fore.aruma.wge(la$positivity, phi = e$phi, theta=e$theta, d=1, s=12, n.ahead = 7, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,7,'ARIMA(12,1,2) With Weekly + Monthly Trends', e$aic) #ASE = .002049

preds <- fore.aruma.wge(la$positivity, phi = e$phi, theta=e$theta, d=0, s=12, n.ahead = 90, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,'ARIMA(12,1,2) With Weekly + Monthly Trends', e$aic) #ASE = .001054

########## Sig Plus Noise ########## 
preds <- fore.sigplusnoise.wge(la$positivity, max.p = 7, n.ahead = 7, limits=F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'SigPlusNoise', 0) #ASE = .000255

preds <- fore.sigplusnoise.wge(la$positivity, max.p = 7, n.ahead = 90, limits=F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'SigPlusNoise', 0) #ASE = .002345 (BAD)


# s7
aic5.wge(la.d7, p=0:12, q=0:5, type='bic')
e <- est.ar.wge(la.d7,p = 8)
ljung.wge(e$res, p=8, K=24)
ljung.wge(e$res, p=8, K=48)
preds <- fore.aruma.wge(la$positivity, phi = e$phi, n.ahead = 7, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,'AR(8) with Weekly Trend 7-Day Forecast', e$aic) #ASE = .002049

preds <- fore.aruma.wge(la$positivity, phi = e$phi, n.ahead = 90, lastn = T, limits = F)
eval_model(la$positivity,preds$f, preds$ul, preds$ll,'AR(8) with Weekly Trend 7-Day Forecast', e$aic) #ASE = .001054


ts_la <- ts(la$positivity[1:239], start = '1')
x = mlp(ts_la, lags = 7, hd.auto.type = 'cv', reps=100)
plot(x)
preds <- predict(x, 7)
plot(preds)
eval_model(la$positivity,preds$mean,7,'NNFOR 7-Day Forecast', 0) #ASE = .000627


ts_la <- ts(la$positivity[1:156], start = '1')
x = mlp(ts_la, lags = 7, m = 1, hd.auto.type = 'cv', reps=100)
plot(x)
preds <- predict(x, 90)
plot(preds)
eval_model(la$positivity,preds$mean,90,'NNFOR 90-Day Forecast', 0) #ASE = .00085


```

```{r RollingWindowASE}

modelA <- fore.aruma.wge(ts, phi = c(-.1, -.7), theta = .1, s = 12, n.ahead = 24, lastn = T)
ASE_A <- mean((modelA$f - ts[477:500])^2)
ASE_A

modelB <- fore.aruma.wge(ts, phi = .8, n.ahead = 24, lastn = T)
ASE_B <- mean((modelB$f - ts[477:500])^2)
ASE_B

#Q2c
ASE_A = c()
ASE_B = c()
winsize = 24
trainingsize = 50
end = length(ts)
for (x in 1:10){
  beg = end - winsize + 1
  #print(beg)
  modelA <- fore.aruma.wge(ts[(end-trainingsize+1):end], phi = c(-.1, -.7), theta = .1, s = 12, n.ahead = winsize, lastn = T)
  modelB <- fore.aruma.wge(ts[(end-trainingsize+1):end], phi = .8, n.ahead = winsize, lastn = T)
  a <- mean((modelA$f - ts[beg:end])^2)
  b <- mean((modelB$f - ts[beg:end])^2)
  #print(end)
  end = end - trainingsize
  ASE_A[x] = a
  ASE_B[x] = b
}

ASE_A
summary(ASE_A)
hist(ASE_A)

ASE_B
summary(ASE_B)
hist(ASE_B)


```


```{r USA}

plotts.sample.wge(us$positivity)
parzen.wge(us$positivity, trunc=200)


us.d1 <- artrans.wge(us$positivity,1)
parzen.wge(us.d1)

#us.s7 <- artrans.wge(us$positivity, c(rep(0,6),1))
#us.d1.s7 <- artrans.wge(us.d1, c(rep(0,6),1))
us.s12 <- artrans.wge(us$positivity, c(rep(0,11),1))
us.d1.s12 <- artrans.wge(us.s12,1)

aic5.wge(us.d1, p=0:12, q=0:5, type='bic') # BIC says 1,1 AIC says 12,2
#aic5.wge(us.s7, p=0:12, q=0:5, type='bic')
#aic5.wge(us.d1.s12, p=0:12, q=0:5, type='bic')
#plotts.sample.wge(us$positiveIncrease)

#Some evidence of a 12 month seasonal trend
est.ar.wge(us.d1, p=12)


e <- est.arma.wge(us.d1, p=1, q=1)
ljung.wge(e$res, p=1,q=1, K=48)

#e <- est.arma.wge(us.s7, p=12, q=2)
#e <- est.arma.wge(us.d1.s12, p=11, q=2)

#e < est.arma.wge(us$positivity, p = 1, q=0)
#fore.aruma.wge(us$positivity, phi=e$phi, n.ahead = 90, lastn = T)

preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 7, lastn = T, limits = F)
#preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, s=7, n.ahead = 7, lastn = T, limits = F)
#preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, s=12, n.ahead = 7, lastn = T, limits = F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'ARIMA(1,1,1)', e$aic) #ASE = .000247

e$ase

#90 day
preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 90, lastn = T, limits = F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'ARIMA(1,1,1)', e$aic)#ASE = .000395

########## ARIMA(12,1,2) ########## 
e <- est.arma.wge(us.d1, p=12, q=2)
ljung.wge(e$res, p=12,q=2, K=24)
ljung.wge(e$res, p=12,q=2, K=48)

preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 7, lastn = T, limits = F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'ARIMA(12,1,2)', e$aic) #ASE = .000156

#90 day
preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 90, lastn = T, limits = F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'ARIMA(12,1,2)', e$aic) #ASE = .000472

########## Sig Plus Noise ########## 
preds <- fore.sigplusnoise.wge(us$positivity, max.p = 12, n.ahead = 7, limits=F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'SigPlusNoise', 0) #ASE = .00019

preds <- fore.sigplusnoise.wge(us$positivity, max.p = 12, n.ahead = 90, limits=F)
eval_model(us$positivity,preds$f, preds$ul, preds$ll,'SigPlusNoise', 0) #ASE = .002618 (BAD)


ts_us <- ts(us$positivity[1:239], start = '1')
x = mlp(ts_us, lags = 7, hd.auto.type = 'cv', reps=100)
plot(x)
preds <- predict(x, 7)
plot(preds)
eval_model(us$positivity,preds$mean,'NNFOR 7-Day Forecast', 0) #ASE = .000244


ts_us <- ts(us$positivity[1:156], start = '1')
x = mlp(ts_us, hd.auto.type = 'cv', reps=100, sel.lag = T)
plot(x)
preds <- predict(x, 90)
plot(preds)
eval_model(us$positivity,preds$mean,'NNFOR 90-Day Forecast', 0) #ASE = .00085

```



```{r Rolling_ASE_function}

rolling_ASE <- function (df, fitted_model, d=0, s=0, horizon=7, training_size=30, model_name){
  ASE = c()
  test_stop <- length(df$positivity)
  plot_list <- list()
  loop_end <- floor(test_stop/(training_size+horizon))

  for (x in 1:loop_end){
    test_start <- test_stop - horizon + 1
    train_start <- test_start - training_size 
    train_stop <- test_start - 1
    print(paste0('test window: ',test_start,':',test_stop,
                 ', train window: ',train_start,':',train_stop))
    data_window <- df$positivity[train_start:train_stop]
    preds <- fore.aruma.wge(data_window, 
                            phi=fitted_model$phi, 
                            theta=fitted_model$theta, 
                            s=s, 
                            d=d, 
                            n.ahead = horizon, 
                            lastn = F, 
                            limits = F)
    a <- mean((preds$f - df$positivity[test_start:test_stop])^2)
    ASE[x] = a
    print(a)
    plot(
      eval_model(
        data_window,
        preds$f, 
        model_name = model_name, 
        AIC_val = fitted_model$aic, 
        pred_ul = preds$ul, 
        pred_ll = preds$ll,
        ending_point = test_stop)
      )
    test_stop = test_stop - training_size
    
    

  }
  hist(ASE)
  return(summary(ASE))
}

########## ARIMA(12,1,2) ########## 
e <- est.arma.wge(us.d1, p=12, q=2)

preds <- fore.aruma.wge(us$positivity, phi = e$phi, theta=e$theta, d=1, n.ahead = 7, lastn = T, limits = F)
#eval_model(us$positivity,preds$f, preds$ul, preds$ll,7,'ARIMA(12,1,2)', e$aic) #ASE = .000156
rolling_ASE(us, e, s=12, d=1, horizon=7, model_name = 'ARIMA(12,1,2)')

#us.s12[(217-12):(239-12)]

```

```{r ConfidenceInterval}
#Dr. Sadler's code for calculating confidence intervals:

#(1-.9B)(1-.8B)Xt = at
#(1-1.7B+.72B^2)Xt = at
#Phi_1 = 1.7  Phi_2 = -.72

s = c(5,8,9,8,7,6,4,3)

#double check psi weights
psi.weights.wge(phi = c(1.7, -.72), lag = 5)

#AR(2)

fit = fore.arma.wge(s,phi = c(1.7, -.72), n.ahead = 3)

#forecasts for l = 1,2 and 3
fit$f

#Conf limits for l = 3
# ll:   1.75415 - 1.96*sqrt(fit$wnv)*sqrt(1+1.7^2+ 2.17^2)
# ul:   1.75415 + 1.96*sqrt(fit$wnv)*sqrt(1+1.7^2+ 2.17^2)
fit$ll[3]
fit$ul[3]

#sigma_at_hat
sqrt(fit$wnv)

#Calc sigma_at_hat
wnv = 1/(8-2) * sum(fit$resid[3:8]^2)
```

```{r}

la_XDF <- data.frame(
  temp = ts(xdf$AvgTempF),
  humidity = ts(xdf$AvgHumidityPercent),
  wind = ts(xdf$AvgWindSpeedMPH),
  precip <- ts(xdf$PrecipitationIN),
  gathering <- ts(xdf$GatheringBinary)
)

x = mlp(ts_la, hd.auto.type = 'cv', reps=100, sel.lag = T, xreg = la_XDF)
plot(x)

## 7 day forecast
preds <- forecast(x, h=7, xreg=la_XDF)
plot(preds)
eval_model(la$positivity, preds$mean,preds$mean,preds$mean, model_name = 'NNFOR', AIC_val = 0) #ASE = .00085

## 90 day forecast
preds <- forecast(x, h=90, xreg=xdf2)
plot(preds)
eval_model(la$positivity, preds$mean,preds$mean,preds$mean, model_name = 'NNFOR', AIC_val = 0) #ASE = .00085


```

